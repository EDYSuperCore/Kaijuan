<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¼€å· Â· å›¾åŒ…è‡ªåŠ¨å±•å¼€å·¥å…·</title>
    <link rel="icon" type="image/png" href="/icon.png">
    <link rel="apple-touch-icon" href="/icon.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f5f5;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 30px;
        }
        
        h1 {
            margin-bottom: 30px;
            color: #2c3e50;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #fafafa;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
        }
        
        .section h2 {
            margin-bottom: 15px;
            color: #34495e;
            font-size: 18px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }
        
        input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        button {
            padding: 10px 20px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
            margin-top: 10px;
        }
        
        button:hover {
            background: #2980b9;
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            display: none;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .file-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            background: white;
        }
        
        .file-item {
            padding: 8px;
            border-bottom: 1px solid #eee;
            font-size: 13px;
        }
        
        .file-item:last-child {
            border-bottom: none;
        }
        
        .file-path {
            color: #666;
            word-break: break-all;
        }
        
        .file-size {
            color: #999;
            font-size: 12px;
        }
        
        .jobs-list {
            max-height: 500px;
            overflow-y: auto;
        }
        
        .job-item {
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            margin-bottom: 16px;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: box-shadow 0.2s, transform 0.2s;
        }
        
        .job-item:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
            transform: translateY(-2px);
        }
        
        .job-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .job-id {
            font-weight: bold;
            color: #2c3e50;
            font-size: 16px;
        }
        
        .btn-delete-job {
            padding: 6px 12px;
            font-size: 12px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .btn-delete-job:hover:not([disabled]) {
            background: #c0392b;
        }
        
        .btn-delete-job[disabled] {
            background: #bdc3c7;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .job-status {
            padding: 6px 14px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .job-status.pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .job-status.running {
            background: #3b82f6;
            color: white;
        }
        
        .job-status.success, .job-status.completed {
            background: #10b981;
            color: white;
        }
        
        .job-status.failed {
            background: #ef4444;
            color: white;
        }
        
        .job-info {
            font-size: 13px;
            color: #666;
            margin-top: 8px;
            line-height: 1.6;
        }
        
        .job-progress-container {
            margin-top: 12px;
            margin-bottom: 12px;
        }
        
        .job-progress-bar {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }
        
        .job-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #60a5fa);
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        
        .job-progress-fill.running {
            background: linear-gradient(90deg, #3b82f6, #60a5fa, #3b82f6);
            background-size: 200% 100%;
            animation: progressShimmer 1.5s ease-in-out infinite;
        }
        
        @keyframes progressShimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        .job-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        
        .btn-view-logs {
            padding: 6px 12px;
            font-size: 12px;
            background: #6b7280;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .btn-view-logs:hover {
            background: #4b5563;
        }
        
        .job-logs {
            display: none;
            margin-top: 12px;
            padding: 12px;
            background: #000;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: #00ff00;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }
        
        .job-logs.show {
            display: block;
        }
        
        .job-logs::-webkit-scrollbar {
            width: 8px;
        }
        
        .job-logs::-webkit-scrollbar-track {
            background: #1a1a1a;
        }
        
        .job-logs::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 4px;
        }
        
        .job-logs::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Logo */
        .app-logo {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 10px;
        }
        
        .app-logo img {
            width: 48px;
            height: 48px;
            border-radius: 8px;
        }
        
        .app-logo h1 {
            margin: 0;
            font-size: 28px;
            color: #2c3e50;
        }
        
        /* Navigation */
        .nav {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .nav a {
            padding: 8px 16px;
            text-decoration: none;
            color: #666;
            border-radius: 4px;
            transition: all 0.2s;
        }
        
        .nav a:hover {
            background: #f0f0f0;
            color: #3498db;
        }
        
        .nav a.active {
            background: #3498db;
            color: white;
        }

        /* Page containers */
        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        /* Settings page styles */
        .radio-group {
            margin-top: 10px;
        }

        .radio-option {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }

        .radio-option input[type="radio"] {
            margin-right: 8px;
            width: auto;
        }

        .radio-option label {
            margin: 0;
            font-weight: normal;
            cursor: pointer;
        }

        .switch-group {
            display: flex;
            align-items: center;
            margin-top: 10px;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
            margin-right: 10px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #3498db;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .warning-box {
            margin-top: 10px;
            padding: 12px;
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 4px;
            color: #856404;
            font-size: 13px;
        }

        .disabled-hint {
            color: #999;
            font-size: 12px;
            font-style: italic;
            margin-top: 5px;
        }

        /* Job Detail page styles */
        .job-detail-summary {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .job-detail-summary h2 {
            margin-bottom: 15px;
            color: #2c3e50;
        }

        .summary-row {
            display: flex;
            gap: 20px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .summary-item {
            flex: 1;
            min-width: 200px;
        }

        .summary-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
        }

        .summary-value {
            font-size: 14px;
            color: #333;
            font-weight: 500;
        }

        .progress-bar-container {
            width: 100%;
            height: 24px;
            background: #e0e0e0;
            border-radius: 12px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2980b9);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: 500;
        }

        .controls-bar {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 20px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
        }

        .controls-bar label {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
            margin: 0;
            cursor: pointer;
        }

        .controls-bar select {
            padding: 5px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .items-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        .items-table th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            font-weight: 500;
            font-size: 13px;
            color: #555;
            border-bottom: 2px solid #e0e0e0;
        }

        .items-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 13px;
        }

        .items-table tr:hover {
            background: #f8f9fa;
        }

        .path-cell {
            max-width: 300px;
            word-break: break-all;
        }

        .path-full {
            display: none;
            position: absolute;
            background: #333;
            color: white;
            padding: 8px;
            border-radius: 4px;
            z-index: 1000;
            max-width: 500px;
            word-break: break-all;
            font-size: 12px;
        }

        .path-cell:hover .path-full {
            display: block;
        }

        .copy-btn {
            padding: 4px 8px;
            font-size: 11px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            margin-left: 5px;
        }

        .copy-btn:hover {
            background: #5a6268;
        }

        .status-tag {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            display: inline-block;
        }

        .status-tag.success {
            background: #d4edda;
            color: #155724;
        }

        .status-tag.failed {
            background: #f8d7da;
            color: #721c24;
        }

        .status-tag.skipped {
            background: #fff3cd;
            color: #856404;
        }

        .status-tag.pending {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-tag.running {
            background: #cce5ff;
            color: #004085;
        }

        .status-tag.canceled {
            background: #e2e3e5;
            color: #383d41;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            background: #28a745;
            color: white;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            z-index: 10000;
            display: none;
        }

        .toast.show {
            display: block;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .error-banner {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            display: none;
        }

        .error-banner.show {
            display: block;
        }

        .version-info {
            position: fixed;
            bottom: 10px;
            right: 10px;
            font-size: 12px;
            color: #999;
            background: rgba(255, 255, 255, 0.9);
            padding: 4px 8px;
            border-radius: 4px;
            z-index: 1000;
        }
        
        /* Dark Mode Styles */
        body.dark-mode {
            background: #111827;
            color: #F3F4F6;
        }
        
        body.dark-mode .container {
            background: #1F2937;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        
        body.dark-mode h1,
        body.dark-mode .app-logo h1 {
            color: #F3F4F6;
        }
        
        body.dark-mode .section {
            background: #374151;
            border-color: #4B5563;
        }
        
        body.dark-mode .section h2 {
            color: #F3F4F6;
        }
        
        body.dark-mode input[type="text"],
        body.dark-mode input[type="password"],
        body.dark-mode select {
            background: #374151;
            border-color: #4B5563;
            color: #F3F4F6;
        }
        
        body.dark-mode .file-list {
            background: #374151;
            border-color: #4B5563;
        }
        
        body.dark-mode .job-item {
            background: #1F2937;
            border-color: #374151;
        }
        
        body.dark-mode .job-id {
            color: #F3F4F6;
        }
        
        body.dark-mode .job-info {
            color: #D1D5DB;
        }
        
        body.dark-mode .job-progress-bar {
            background: #374151;
        }
        
        body.dark-mode .nav {
            border-bottom-color: #4B5563;
        }
        
        body.dark-mode .nav a {
            color: #D1D5DB;
        }
        
        body.dark-mode .nav a:hover {
            background: #374151;
            color: #60a5fa;
        }
        
        body.dark-mode .nav a.active {
            background: #3b82f6;
            color: white;
        }
        
        body.dark-mode label {
            color: #D1D5DB;
        }
        
        body.dark-mode .file-item {
            border-bottom-color: #4B5563;
        }
        
        body.dark-mode .file-path {
            color: #D1D5DB;
        }
        
        body.dark-mode .version-info {
            background: rgba(31, 41, 55, 0.9);
            color: #9CA3AF;
        }
        
        /* Dark Mode Toggle */
        .dark-mode-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10001;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            cursor: pointer;
            transition: background 0.2s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        body.dark-mode .dark-mode-toggle {
            background: rgba(31, 41, 55, 0.9);
        }
        
        .dark-mode-toggle:hover {
            background: rgba(255, 255, 255, 1);
        }
        
        body.dark-mode .dark-mode-toggle:hover {
            background: rgba(31, 41, 55, 1);
        }
        
        .dark-mode-toggle span {
            font-size: 14px;
            color: #333;
        }
        
        body.dark-mode .dark-mode-toggle span {
            color: #F3F4F6;
        }
        
        .dark-mode-toggle-icon {
            font-size: 18px;
        }
        
        /* Modal Styles */
        .config-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }
        
        body.dark-mode .config-modal {
            background: rgba(0,0,0,0.7);
        }
        
        .config-modal.show {
            display: flex;
        }
        
        .config-modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        body.dark-mode .config-modal-content {
            background: #1F2937;
        }
        
        .config-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .config-modal-header h2 {
            margin: 0;
            color: #2c3e50;
        }
        
        body.dark-mode .config-modal-header h2 {
            color: #F3F4F6;
        }
        
        .config-modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: background 0.2s;
        }
        
        .config-modal-close:hover {
            background: #f0f0f0;
        }
        
        body.dark-mode .config-modal-close {
            color: #D1D5DB;
        }
        
        body.dark-mode .config-modal-close:hover {
            background: #374151;
        }
        
        .config-modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }
        
        body.dark-mode .radio-option label {
            color: #D1D5DB;
        }
        
        body.dark-mode #modalPasswordTryListHint {
            background: #374151;
            color: #D1D5DB;
        }
        
        body.dark-mode .job-logs {
            background: #000;
            color: #00ff00;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- App Logo and Title -->
        <div class="app-logo">
            <img src="/icon.png" alt="å¼€å· Logo">
            <div>
                <h1>å¼€å·</h1>
                <p style="color: #666; margin-top: -5px; margin-bottom: 0; font-size: 14px;">Kaijuan â€” Archive Unfolder</p>
            </div>
        </div>
        
        <!-- Navigation -->
        <div class="nav">
            <a href="#" id="navHome" class="active">é¦–é¡µ</a>
            <a href="#settings" id="navSettings">è®¾ç½®</a>
        </div>

        <!-- Home Page -->
        <div id="pageHome" class="page active">
            <!-- æ‰«æå’Œåˆ›å»ºä»»åŠ¡åŒºåŸŸ -->
            <div class="section">
                <h2>æ‰«æå¹¶åˆ›å»ºä»»åŠ¡</h2>
                <div class="form-group">
                    <label for="rootPath">ç›®å½•è·¯å¾„:</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="rootPath" placeholder="ä¾‹å¦‚: /volume1/archives" value="" style="flex: 1;">
                        <button id="selectDirBtn" style="background: #95a5a6; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; white-space: nowrap;">é€‰æ‹©ç›®å½•</button>
                    </div>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button id="scanBtn">æ‰«æ</button>
                    <button id="createJobBtn" disabled>åˆ›å»ºä»»åŠ¡</button>
                </div>
                <div id="scanStatus" class="status"></div>
                <div id="createJobStatus" class="status"></div>
                
                <div id="fileList" class="file-list" style="display: none; margin-top: 15px;">
                    <div id="fileListContent"></div>
                </div>
            </div>
        
        <!-- ä»»åŠ¡åˆ—è¡¨åŒºåŸŸ -->
        <div class="section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h2 style="margin: 0;">ä»»åŠ¡åˆ—è¡¨</h2>
                <button id="clearFailedBtn" class="btn" style="background: #e74c3c;">æ¸…é™¤å¤±è´¥ä»»åŠ¡</button>
            </div>
            <div id="jobsList" class="jobs-list">
                <div style="text-align: center; color: #999; padding: 20px;">
                    æš‚æ— ä»»åŠ¡ï¼Œè¯·å…ˆæ‰«æå¹¶åˆ›å»ºä»»åŠ¡
                </div>
            </div>
        </div>
        </div>

        <!-- Settings Page -->
        <div id="pageSettings" class="page">
            <div class="section">
                <h2>åº”ç”¨è®¾ç½®</h2>
                
                <!-- Conflict Policy -->
                <div class="form-group">
                    <label>å†²çªç­–ç•¥</label>
                    <div class="radio-group">
                        <div class="radio-option">
                            <input type="radio" id="conflictSkip" name="conflict" value="skip">
                            <label for="conflictSkip">è·³è¿‡ - å¦‚æœç›®æ ‡å·²å­˜åœ¨åˆ™è·³è¿‡è¯¥æ–‡ä»¶</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="conflictOverwrite" name="conflict" value="overwrite">
                            <label for="conflictOverwrite">è¦†ç›– - å¦‚æœç›®æ ‡å·²å­˜åœ¨åˆ™è¦†ç›–</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="conflictRename" name="conflict" value="rename">
                            <label for="conflictRename">é‡å‘½å - å¦‚æœç›®æ ‡å·²å­˜åœ¨åˆ™è‡ªåŠ¨é‡å‘½å</label>
                        </div>
                    </div>
                </div>

                <!-- Output Mode -->
                <div class="form-group">
                    <label>è¾“å‡ºæ–¹å¼</label>
                    <div class="radio-group">
                        <div class="radio-option">
                            <input type="radio" id="outputSibling" name="outputMode" value="sibling_named_dir">
                            <label for="outputSibling">åŒçº§å‘½åç›®å½• - åœ¨å‹ç¼©åŒ…åŒçº§åˆ›å»ºåŒåç›®å½•</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="outputInPlace" name="outputMode" value="in_place" disabled>
                            <label for="outputInPlace" style="color: #999;">åŸåœ°è§£å‹ - ç›´æ¥è§£å‹åˆ°å‹ç¼©åŒ…æ‰€åœ¨ç›®å½•ï¼ˆæš‚æœªå®ç°ï¼‰</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="outputCustom" name="outputMode" value="custom" disabled>
                            <label for="outputCustom" style="color: #999;">è‡ªå®šä¹‰ç›®å½• - è§£å‹åˆ°æŒ‡å®šç›®å½•ï¼ˆæš‚æœªå®ç°ï¼‰</label>
                        </div>
                    </div>
                    <div class="disabled-hint">å½“å‰ä»…æ”¯æŒ"åŒçº§å‘½åç›®å½•"æ¨¡å¼</div>
                </div>

                <!-- Zip Slip Policy -->
                <div class="form-group">
                    <label>Zip Slip é˜²æŠ¤</label>
                    <div class="switch-group">
                        <label class="switch">
                            <input type="checkbox" id="zipSlipPolicy">
                            <span class="slider"></span>
                        </label>
                        <label for="zipSlipPolicy" style="margin: 0; cursor: pointer;">å…è®¸è·¯å¾„ç©¿è¶Šï¼ˆå±é™©ï¼‰</label>
                    </div>
                    <div id="zipSlipWarning" class="warning-box" style="display: none;">
                        <strong>âš ï¸ å®‰å…¨è­¦å‘Šï¼š</strong>å¼€å¯æ­¤é€‰é¡¹å°†å…è®¸å‹ç¼©åŒ…ä¸­çš„æ–‡ä»¶è§£å‹åˆ°ç›®æ ‡ç›®å½•ä¹‹å¤–ï¼Œå¯èƒ½å¯¼è‡´ç³»ç»Ÿæ–‡ä»¶è¢«è¦†ç›–æˆ–æ³„éœ²ã€‚å¼ºçƒˆå»ºè®®ä¿æŒå…³é—­çŠ¶æ€ã€‚
                    </div>
                </div>

                <!-- Common Passwords -->
                <div class="form-group">
                    <label>å¸¸ç”¨å¯†ç </label>
                    <div style="margin-bottom: 10px; font-size: 13px; color: #666;">
                        ç®¡ç†å¸¸ç”¨è§£å‹å¯†ç åˆ—è¡¨ï¼Œç”¨äºæ‰¹é‡è§£å‹åŠ å¯†å‹ç¼©åŒ…
                    </div>
                    <div id="commonPasswordsList" style="margin-bottom: 10px;">
                        <!-- Password items will be dynamically added here -->
                    </div>
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <input type="password" id="newPasswordInput" placeholder="è¾“å…¥æ–°å¯†ç " style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <button id="addPasswordBtn" style="padding: 8px 16px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer;">æ·»åŠ </button>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div style="margin-top: 20px;">
                    <button id="resetSettingsBtn" style="background: #95a5a6;">é‡ç½®ä¸ºé»˜è®¤</button>
                    <span id="settingsSaveStatus" style="margin-left: 10px; font-size: 13px; color: #666;"></span>
                </div>
                <div id="settingsStatus" class="status"></div>
            </div>
        </div>

        <!-- Job Detail Page -->
        <div id="pageJobDetail" class="page">
            <div style="margin-bottom: 20px;">
                <button id="backToJobsBtn" style="background: #95a5a6; margin-bottom: 15px;">â† è¿”å›ä»»åŠ¡åˆ—è¡¨</button>
            </div>

            <div id="jobDetailError" class="error-banner"></div>

            <div id="jobDetailContent" style="display: none;">
                <!-- Summary Card -->
                <div class="job-detail-summary">
                    <h2>ä»»åŠ¡è¯¦æƒ… #<span id="jobDetailId"></span></h2>
                    
                    <div class="summary-row">
                        <div class="summary-item">
                            <div class="summary-label">è·¯å¾„</div>
                            <div class="summary-value" id="jobDetailRootPath"></div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">çŠ¶æ€</div>
                            <div class="summary-value" id="jobDetailStatus"></div>
                        </div>
                    </div>

                    <div class="summary-row">
                        <div class="summary-item">
                            <div class="summary-label">è¿›åº¦</div>
                            <div class="progress-bar-container">
                                <div class="progress-bar" id="jobDetailProgressBar" style="width: 0%;">0%</div>
                            </div>
                        </div>
                    </div>

                    <div class="summary-row">
                        <div class="summary-item">
                            <div class="summary-label">æˆåŠŸ</div>
                            <div class="summary-value" id="jobDetailSuccess">0</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">å¤±è´¥</div>
                            <div class="summary-value" id="jobDetailFailed">0</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">è·³è¿‡</div>
                            <div class="summary-value" id="jobDetailSkipped">0</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">å·²å–æ¶ˆ</div>
                            <div class="summary-value" id="jobDetailCanceled">0</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">æ€»è®¡</div>
                            <div class="summary-value" id="jobDetailTotal">0</div>
                        </div>
                    </div>

                    <div class="summary-row">
                        <div class="summary-item">
                            <div class="summary-label">åˆ›å»ºæ—¶é—´</div>
                            <div class="summary-value" id="jobDetailCreatedAt"></div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">å¼€å§‹æ—¶é—´</div>
                            <div class="summary-value" id="jobDetailStartedAt"></div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">ç»“æŸæ—¶é—´</div>
                            <div class="summary-value" id="jobDetailEndedAt"></div>
                        </div>
                    </div>
                </div>

                <!-- Controls -->
                <div class="controls-bar">
                    <label>
                        <input type="checkbox" id="autoRefreshToggle" checked>
                        è‡ªåŠ¨åˆ·æ–°
                    </label>
                    <select id="refreshInterval">
                        <option value="1000">1ç§’</option>
                        <option value="2000" selected>2ç§’</option>
                        <option value="5000">5ç§’</option>
                    </select>
                    <label>
                        <input type="checkbox" id="filterFailed">
                        ä»…æ˜¾ç¤ºå¤±è´¥
                    </label>
                    <button id="manualRefreshBtn">æ‰‹åŠ¨åˆ·æ–°</button>
                </div>

                <!-- Items Table -->
                <div class="section">
                    <h2>ä»»åŠ¡é¡¹åˆ—è¡¨</h2>
                    <div style="overflow-x: auto;">
                        <table class="items-table">
                            <thead>
                                <tr>
                                    <th style="width: 30%;">è·¯å¾„</th>
                                    <th style="width: 10%;">çŠ¶æ€</th>
                                    <th style="width: 30%;">æ¶ˆæ¯</th>
                                    <th style="width: 20%;">è¾“å‡ºç›®å½•</th>
                                    <th style="width: 10%;">è€—æ—¶</th>
                                </tr>
                            </thead>
                            <tbody id="jobDetailItemsTable">
                                <tr>
                                    <td colspan="5" style="text-align: center; padding: 20px; color: #999;">
                                        åŠ è½½ä¸­...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast for copy feedback -->
    <div id="toast" class="toast">å·²å¤åˆ¶åˆ°å‰ªè´´æ¿</div>
    
    <!-- Version info -->
    <div id="versionInfo" class="version-info">Version: <span id="versionText">loading...</span></div>
    
    <!-- Dark Mode Toggle -->
    <div class="dark-mode-toggle" id="darkModeToggle">
        <span class="dark-mode-toggle-icon" id="darkModeIcon">ğŸŒ™</span>
        <span id="darkModeText">æš—é»‘æ¨¡å¼</span>
    </div>
    
    <!-- Config Modal -->
    <div id="configModal" class="config-modal">
        <div class="config-modal-content">
            <div class="config-modal-header">
                <h2>åˆ›å»ºè§£å‹ä»»åŠ¡</h2>
                <button class="config-modal-close" id="closeConfigModal">&times;</button>
            </div>
            
            <div class="form-group">
                <label>è§£å‹å¯†ç </label>
                <div class="radio-group">
                    <div class="radio-option">
                        <input type="radio" id="modalPasswordNone" name="modalPasswordMode" value="none" checked>
                        <label for="modalPasswordNone">ä¸ä½¿ç”¨å¯†ç </label>
                    </div>
                    <div class="radio-option">
                        <input type="radio" id="modalPasswordSelect" name="modalPasswordMode" value="select">
                        <label for="modalPasswordSelect">ä»å¸¸ç”¨å¯†ç é€‰æ‹©</label>
                    </div>
                    <div class="radio-option">
                        <input type="radio" id="modalPasswordManual" name="modalPasswordMode" value="manual">
                        <label for="modalPasswordManual">æœ¬æ¬¡æ‰‹åŠ¨è¾“å…¥</label>
                    </div>
                    <div class="radio-option">
                        <input type="radio" id="modalPasswordTryList" name="modalPasswordMode" value="try_list">
                        <label for="modalPasswordTryList">æŒ¨ä¸ªå°è¯•å¸¸ç”¨å¯†ç </label>
                    </div>
                </div>
                
                <!-- Password Select Dropdown -->
                <div id="modalPasswordSelectGroup" style="display: none; margin-top: 10px;">
                    <select id="modalPasswordSelectDropdown" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="">è¯·é€‰æ‹©å¯†ç </option>
                    </select>
                </div>
                
                <!-- Manual Password Input -->
                <div id="modalPasswordManualGroup" style="display: none; margin-top: 10px;">
                    <input type="password" id="modalPasswordManualInput" placeholder="è¾“å…¥è§£å‹å¯†ç " style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                
                <!-- Try List Hint -->
                <div id="modalPasswordTryListHint" style="display: none; margin-top: 10px; padding: 8px; background: #e7f3ff; border-radius: 4px; font-size: 13px; color: #666;">
                    å°†æŒ‰å¸¸ç”¨å¯†ç é¡ºåºä¾æ¬¡å°è¯•ï¼Œç›´åˆ°æˆåŠŸæˆ–å…¨éƒ¨å¤±è´¥
                </div>
            </div>
            
            <div class="form-group">
                <label>å†²çªç­–ç•¥</label>
                <div class="radio-group">
                    <div class="radio-option">
                        <input type="radio" id="modalConflictSkip" name="modalConflict" value="skip">
                        <label for="modalConflictSkip">è·³è¿‡ - å¦‚æœç›®æ ‡å·²å­˜åœ¨åˆ™è·³è¿‡è¯¥æ–‡ä»¶</label>
                    </div>
                    <div class="radio-option">
                        <input type="radio" id="modalConflictOverwrite" name="modalConflict" value="overwrite">
                        <label for="modalConflictOverwrite">è¦†ç›– - å¦‚æœç›®æ ‡å·²å­˜åœ¨åˆ™è¦†ç›–</label>
                    </div>
                    <div class="radio-option">
                        <input type="radio" id="modalConflictRename" name="modalConflict" value="rename">
                        <label for="modalConflictRename">é‡å‘½å - å¦‚æœç›®æ ‡å·²å­˜åœ¨åˆ™è‡ªåŠ¨é‡å‘½å</label>
                    </div>
                </div>
            </div>
            
            <div id="configModalStatus" class="status" style="display: none;"></div>
            
            <div class="config-modal-footer">
                <button id="cancelConfigBtn" style="background: #95a5a6; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">å–æ¶ˆ</button>
                <button id="confirmConfigBtn" style="background: #3498db; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">ç¡®è®¤å¼€å§‹</button>
            </div>
        </div>
    </div>
    
    <!-- Directory Selector Modal -->
    <div id="dirSelectorModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center;">
        <div style="background: white; padding: 30px; border-radius: 8px; max-width: 600px; width: 90%; max-height: 80vh; box-shadow: 0 4px 20px rgba(0,0,0,0.3); display: flex; flex-direction: column;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0;">é€‰æ‹©ç›®å½•</h2>
                <button id="closeDirSelector" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
            </div>
            
            <div style="display: flex; gap: 10px; margin-bottom: 15px; align-items: center;">
                <button id="dirSelectorGoRoot" style="background: #95a5a6; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 12px;">å›åˆ°æ ¹ç›®å½•</button>
                <button id="dirSelectorGoUp" style="background: #95a5a6; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 12px;">è¿”å›ä¸Šä¸€çº§</button>
                <div style="flex: 1; padding: 8px; background: #f5f5f5; border-radius: 4px; font-size: 13px; word-break: break-all;" id="dirSelectorCurrentPath">/</div>
            </div>
            
            <div id="dirSelectorLoading" style="text-align: center; padding: 20px; color: #999; display: none;">åŠ è½½ä¸­...</div>
            <div id="dirSelectorError" class="error-banner" style="display: none;"></div>
            
            <div id="dirSelectorList" style="flex: 1; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; padding: 10px; min-height: 200px; max-height: 400px;">
                <!-- Directory items will be rendered here -->
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                <button id="dirSelectorCancel" style="background: #95a5a6; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">å–æ¶ˆ</button>
                <button id="dirSelectorConfirm" style="background: #3498db; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">é€‰æ‹©å½“å‰ç›®å½•</button>
            </div>
        </div>
    </div>
    
    <!-- Retry Job Modal -->
    <div id="retryJobModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center;">
        <div style="background: white; padding: 30px; border-radius: 8px; max-width: 500px; width: 90%; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0;">é‡è¯•ä»»åŠ¡</h2>
                <button id="closeRetryModal" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
            </div>
            
            <div id="retryJobError" class="error-banner" style="display: none;"></div>
            
            <div class="form-group" style="margin-bottom: 15px;">
                <label>è§£å‹å¯†ç </label>
                <div class="radio-group">
                    <div class="radio-option">
                        <input type="radio" id="retryPasswordNone" name="retryPasswordMode" value="none" checked>
                        <label for="retryPasswordNone">ä¸ä½¿ç”¨å¯†ç </label>
                    </div>
                    <div class="radio-option">
                        <input type="radio" id="retryPasswordSelect" name="retryPasswordMode" value="select">
                        <label for="retryPasswordSelect">ä»å¸¸ç”¨å¯†ç é€‰æ‹©</label>
                    </div>
                    <div class="radio-option">
                        <input type="radio" id="retryPasswordManual" name="retryPasswordMode" value="manual">
                        <label for="retryPasswordManual">æœ¬æ¬¡æ‰‹åŠ¨è¾“å…¥</label>
                    </div>
                    <div class="radio-option">
                        <input type="radio" id="retryPasswordTryList" name="retryPasswordMode" value="try_list">
                        <label for="retryPasswordTryList">æŒ¨ä¸ªå°è¯•å¸¸ç”¨å¯†ç </label>
                    </div>
                </div>
                
                <div id="retryPasswordSelectGroup" style="display: none; margin-top: 10px;">
                    <select id="retryPasswordSelectDropdown" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="">è¯·é€‰æ‹©å¯†ç </option>
                    </select>
                </div>
                
                <div id="retryPasswordManualGroup" style="display: none; margin-top: 10px;">
                    <input type="password" id="retryPasswordManualInput" placeholder="è¾“å…¥è§£å‹å¯†ç " style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                
                <div id="retryPasswordTryListHint" style="display: none; margin-top: 10px; padding: 8px; background: #e7f3ff; border-radius: 4px; font-size: 13px; color: #666;">
                    å°†æŒ‰å¸¸ç”¨å¯†ç é¡ºåºä¾æ¬¡å°è¯•ï¼Œç›´åˆ°æˆåŠŸæˆ–å…¨éƒ¨å¤±è´¥
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                <button id="cancelRetryBtn" style="background: #95a5a6; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">å–æ¶ˆ</button>
                <button id="confirmRetryBtn" style="background: #f39c12; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">ç¡®è®¤é‡è¯•</button>
            </div>
        </div>
    </div>
    
    <script>
        const API_BASE = '/api';
        let selectedFiles = [];
        let pollInterval = null;
        let currentSettings = null;
        let commonPasswords = []; // Editable common passwords list
        let jobLogCache = {}; // Cache for job logs (jobId -> content)
        const DEFAULT_SETTINGS = {
            conflict: 'skip',
            outputMode: 'sibling_named_dir',
            zipSlipPolicy: 'block'
        };
        
        // Password preview configuration
        const PASSWORD_PREVIEW_LEN = 4; // Fixed preview length (can be made configurable later)
        
        // Auto-save state
        let autoSaveTimer = null;
        let isSaving = false;
        let pendingSave = null;
        let saveRequestId = 0;

        // ========== Routing ==========
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(pageId).classList.add('active');

            document.querySelectorAll('.nav a').forEach(link => {
                link.classList.remove('active');
            });
            if (pageId === 'pageHome') {
                document.getElementById('navHome').classList.add('active');
            } else if (pageId === 'pageSettings') {
                document.getElementById('navSettings').classList.add('active');
            }
        }

        // Handle hash routing
        function handleRoute() {
            const hash = window.location.hash;
            if (hash === '#settings') {
                showPage('pageSettings');
                loadSettings();
            } else if (hash.startsWith('#jobs/')) {
                const jobId = hash.substring(6);
                if (jobId && /^\d+$/.test(jobId)) {
                    showPage('pageJobDetail');
                    loadJobDetail(parseInt(jobId));
                } else {
                    showPage('pageHome');
                }
            } else {
                showPage('pageHome');
            }
        }

        window.addEventListener('hashchange', handleRoute);
        window.addEventListener('load', handleRoute);

        // Navigation click handlers
        document.getElementById('navHome').addEventListener('click', (e) => {
            e.preventDefault();
            window.location.hash = '';
            showPage('pageHome');
        });

        document.getElementById('navSettings').addEventListener('click', (e) => {
            e.preventDefault();
            window.location.hash = 'settings';
            showPage('pageSettings');
            loadSettings();
        });

        // ========== Settings Page ==========
        async function loadSettings() {
            try {
                const res = await fetch(`${API_BASE}/settings`);
                const data = await res.json();
                
                if (data.error) {
                    showStatus('settingsStatus', `åŠ è½½è®¾ç½®å¤±è´¥: ${data.error}`, true);
                    return;
                }

                // If settings is null (not configured), use default values for UI display only
                // User must save settings before submitting jobs
                if (!data || data === null) {
                    currentSettings = null;
                    commonPasswords = [];
                    // Apply default values to form for display, but these are not saved
                    applySettingsToForm({
                        conflict: 'skip',
                        outputMode: 'sibling_named_dir',
                        zipSlipPolicy: 'block',
                        commonPasswords: []
                    });
                    showStatus('settingsStatus', 'è®¾ç½®æœªé…ç½®ï¼Œè¯·å®Œæˆé…ç½®åä¿å­˜', false);
                    return;
                }

                currentSettings = data;
                applySettingsToForm(data);
                // Update password dropdown when settings are loaded
                updatePasswordSelectDropdown();
                updateModalPasswordSelectDropdown();
            } catch (err) {
                showStatus('settingsStatus', `åŠ è½½è®¾ç½®å¤±è´¥: ${err.message}`, true);
            }
        }

        function applySettingsToForm(settings) {
            // Conflict
            document.getElementById(`conflict${settings.conflict.charAt(0).toUpperCase() + settings.conflict.slice(1)}`).checked = true;

            // Output Mode
            const outputModeMap = {
                'sibling_named_dir': 'outputSibling',
                'in_place': 'outputInPlace',
                'custom': 'outputCustom'
            };
            const outputRadioId = outputModeMap[settings.outputMode] || 'outputSibling';
            document.getElementById(outputRadioId).checked = true;

            // Zip Slip Policy
            document.getElementById('zipSlipPolicy').checked = settings.zipSlipPolicy === 'allow';
            updateZipSlipWarning(settings.zipSlipPolicy === 'allow');

            // Common Passwords
            commonPasswords = settings.commonPasswords || [];
            renderPasswordList();
        }

        /**
         * Get password preview (prefix + mask)
         * @param {string} password - Full password
         * @param {number} previewLen - Preview length (default: PASSWORD_PREVIEW_LEN)
         * @returns {string} Preview string like "abcâ€¢â€¢â€¢â€¢"
         */
        function getPasswordPreview(password, previewLen = PASSWORD_PREVIEW_LEN) {
            if (!password || password.length === 0) {
                return 'â€¢â€¢â€¢â€¢';
            }
            const prefix = password.slice(0, Math.min(previewLen, password.length));
            const mask = 'â€¢â€¢â€¢â€¢';
            return `${prefix}${mask}`;
        }

        /**
         * Get password preview for logging (safe, no full password)
         */
        function getPasswordPreviewForLog(password, index, previewLen = PASSWORD_PREVIEW_LEN) {
            const preview = getPasswordPreview(password, previewLen);
            return `${preview}(#${index + 1})`;
        }

        function renderPasswordList() {
            const listEl = document.getElementById('commonPasswordsList');
            listEl.innerHTML = '';
            
            if (commonPasswords.length === 0) {
                listEl.innerHTML = '<div style="color: #999; font-size: 13px; padding: 10px;">æš‚æ— å¸¸ç”¨å¯†ç </div>';
                return;
            }

            commonPasswords.forEach((pwd, index) => {
                const item = document.createElement('div');
                item.style.cssText = 'display: flex; align-items: center; gap: 10px; padding: 8px; background: #f8f9fa; border-radius: 4px; margin-bottom: 8px;';
                
                const indexSpan = document.createElement('span');
                indexSpan.textContent = `#${index + 1}`;
                indexSpan.style.cssText = 'font-weight: 500; color: #666; min-width: 30px;';
                
                // Password preview display (prefix + mask)
                const pwdDisplay = document.createElement('span');
                const preview = getPasswordPreview(pwd);
                pwdDisplay.textContent = preview;
                pwdDisplay.style.cssText = 'flex: 1; font-family: monospace; font-size: 13px;';
                pwdDisplay.dataset.password = pwd;
                pwdDisplay.dataset.showingFull = 'false';
                pwdDisplay.style.cursor = 'pointer';
                pwdDisplay.title = 'ç‚¹å‡»æ˜¾ç¤ºå®Œæ•´å¯†ç ï¼ˆä»…æœ¬åœ°æŸ¥çœ‹ï¼‰';
                
                // Eye icon button for show/hide
                const eyeBtn = document.createElement('button');
                eyeBtn.textContent = 'ğŸ‘';
                eyeBtn.style.cssText = 'padding: 4px 8px; background: #6c757d; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 12px;';
                eyeBtn.title = 'æ˜¾ç¤º/éšè—å®Œæ•´å¯†ç ';
                eyeBtn.onclick = function() {
                    const showingFull = pwdDisplay.dataset.showingFull === 'true';
                    if (showingFull) {
                        pwdDisplay.textContent = preview;
                        pwdDisplay.dataset.showingFull = 'false';
                    } else {
                        pwdDisplay.textContent = pwd;
                        pwdDisplay.dataset.showingFull = 'true';
                        // Auto-hide after 3 seconds
                        setTimeout(() => {
                            if (pwdDisplay.dataset.showingFull === 'true') {
                                pwdDisplay.textContent = preview;
                                pwdDisplay.dataset.showingFull = 'false';
                            }
                        }, 3000);
                    }
                };
                
                const upBtn = document.createElement('button');
                upBtn.textContent = 'â†‘';
                upBtn.style.cssText = 'padding: 4px 8px; background: #95a5a6; color: white; border: none; border-radius: 3px; cursor: pointer;';
                upBtn.disabled = index === 0;
                upBtn.onclick = () => {
                    if (index > 0) {
                        [commonPasswords[index], commonPasswords[index - 1]] = [commonPasswords[index - 1], commonPasswords[index]];
                        renderPasswordList();
                        scheduleAutoSave();
                    }
                };
                
                const downBtn = document.createElement('button');
                downBtn.textContent = 'â†“';
                downBtn.style.cssText = 'padding: 4px 8px; background: #95a5a6; color: white; border: none; border-radius: 3px; cursor: pointer;';
                downBtn.disabled = index === commonPasswords.length - 1;
                downBtn.onclick = () => {
                    if (index < commonPasswords.length - 1) {
                        [commonPasswords[index], commonPasswords[index + 1]] = [commonPasswords[index + 1], commonPasswords[index]];
                        renderPasswordList();
                        scheduleAutoSave();
                    }
                };
                
                const delBtn = document.createElement('button');
                delBtn.textContent = 'åˆ é™¤';
                delBtn.style.cssText = 'padding: 4px 8px; background: #e74c3c; color: white; border: none; border-radius: 3px; cursor: pointer;';
                delBtn.onclick = () => {
                    commonPasswords.splice(index, 1);
                    renderPasswordList();
                    scheduleAutoSave();
                };
                
                item.appendChild(indexSpan);
                item.appendChild(pwdDisplay);
                item.appendChild(eyeBtn);
                item.appendChild(upBtn);
                item.appendChild(downBtn);
                item.appendChild(delBtn);
                listEl.appendChild(item);
            });
        }

        // Add password button event
        document.getElementById('addPasswordBtn').addEventListener('click', () => {
            const input = document.getElementById('newPasswordInput');
            const pwd = input.value.trim();
            if (pwd) {
                commonPasswords.push(pwd);
                input.value = '';
                renderPasswordList();
                // Log preview only (no full password)
                const previews = commonPasswords.map((p, i) => getPasswordPreviewForLog(p, i));
                console.log('[settings] Added password, current count:', commonPasswords.length, 'previews:', previews);
                scheduleAutoSave();
            } else {
                showStatus('settingsStatus', 'è¯·è¾“å…¥å¯†ç ', true);
            }
        });

        // Enter key support for password input
        document.getElementById('newPasswordInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('addPasswordBtn').click();
            }
        });

        function updateZipSlipWarning(enabled) {
            const warning = document.getElementById('zipSlipWarning');
            warning.style.display = enabled ? 'block' : 'none';
        }

        document.getElementById('zipSlipPolicy').addEventListener('change', (e) => {
            updateZipSlipWarning(e.target.checked);
        });

        /**
         * Schedule auto-save with debounce
         * Debounce time: 500ms
         */
        function scheduleAutoSave() {
            // Clear existing timer
            if (autoSaveTimer) {
                clearTimeout(autoSaveTimer);
            }

            // Store current state as pending save
            pendingSave = {
                conflict: document.querySelector('input[name="conflict"]:checked')?.value,
                outputMode: document.querySelector('input[name="outputMode"]:checked')?.value,
                zipSlipPolicy: document.getElementById('zipSlipPolicy').checked ? 'allow' : 'block',
                commonPasswords: [...commonPasswords] // Copy array
            };

            // Set new timer
            autoSaveTimer = setTimeout(() => {
                performAutoSave();
            }, 500);
        }

        /**
         * Perform auto-save (with concurrent control)
         */
        async function performAutoSave() {
            // If already saving, mark that we have pending changes
            if (isSaving) {
                return; // Will be handled after current save completes
            }

            if (!pendingSave) {
                return; // Nothing to save
            }

            isSaving = true;
            const currentRequestId = ++saveRequestId;
            const saveData = { ...pendingSave };
            pendingSave = null;

            // Update status
            const statusEl = document.getElementById('settingsSaveStatus');
            statusEl.textContent = 'ä¿å­˜ä¸­...';
            statusEl.style.color = '#666';

            try {
                // Log preview only (no full passwords)
                const previews = saveData.commonPasswords.map((p, i) => getPasswordPreviewForLog(p, i));
                console.log('[settings] auto-save payload', {
                    conflict: saveData.conflict,
                    outputMode: saveData.outputMode,
                    zipSlipPolicy: saveData.zipSlipPolicy,
                    commonPasswordsCount: saveData.commonPasswords.length,
                    commonPasswordsPreview: previews
                });

                const res = await fetch(`${API_BASE}/settings`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(saveData)
                });

                const data = await res.json();

                // Only process if this is the latest request
                if (currentRequestId !== saveRequestId) {
                    console.log('[settings] Ignoring outdated save response');
                    return;
                }

                // Log response (no passwords)
                console.log('[settings] auto-save response', {
                    status: res.status,
                    ok: res.ok,
                    requestId: currentRequestId,
                    error: data.error || null
                });

                if (!res.ok || data.error) {
                    throw new Error(data.error || 'Unknown error');
                }

                // Success
                currentSettings = data;
                commonPasswords = data.commonPasswords || [];
                renderPasswordList();
                
                statusEl.textContent = 'å·²è‡ªåŠ¨ä¿å­˜';
                statusEl.style.color = '#28a745';
                setTimeout(() => {
                    if (statusEl.textContent === 'å·²è‡ªåŠ¨ä¿å­˜') {
                        statusEl.textContent = '';
                    }
                }, 2000);

                // If there are new pending changes, save again
                if (pendingSave) {
                    setTimeout(() => performAutoSave(), 100);
                }
            } catch (err) {
                console.error('[settings] auto-save error:', err);
                
                // Only show error if this is the latest request
                if (currentRequestId === saveRequestId) {
                    statusEl.textContent = 'ä¿å­˜å¤±è´¥ï¼Œç‚¹å‡»é‡è¯•';
                    statusEl.style.color = '#e74c3c';
                    statusEl.style.cursor = 'pointer';
                    statusEl.onclick = () => {
                        scheduleAutoSave();
                        setTimeout(() => performAutoSave(), 100);
                    };
                    
                    showStatus('settingsStatus', `ä¿å­˜å¤±è´¥: ${err.message}`, true);
                }
            } finally {
                if (currentRequestId === saveRequestId) {
                    isSaving = false;
                }
            }
        }

        // Auto-save on conflict/outputMode/zipSlipPolicy changes
        document.querySelectorAll('input[name="conflict"]').forEach(radio => {
            radio.addEventListener('change', scheduleAutoSave);
        });
        document.querySelectorAll('input[name="outputMode"]').forEach(radio => {
            radio.addEventListener('change', scheduleAutoSave);
        });
        document.getElementById('zipSlipPolicy').addEventListener('change', scheduleAutoSave);

        // Reset to default
        document.getElementById('resetSettingsBtn').addEventListener('click', () => {
            commonPasswords = [];
            applySettingsToForm({ ...DEFAULT_SETTINGS, commonPasswords: [] });
            updateZipSlipWarning(false);
            showStatus('settingsStatus', 'å·²é‡ç½®ä¸ºé»˜è®¤å€¼ï¼ˆæœªä¿å­˜ï¼‰', false);
        });

        // ========== Home Page ==========
        // æ£€æŸ¥å¥åº·çŠ¶æ€
        async function checkHealth() {
            try {
                const res = await fetch(`${API_BASE}/health`);
                const data = await res.json();
                console.log('Health check:', data);
                return data.ok;
            } catch (err) {
                console.error('Health check failed:', err);
                return false;
            }
        }
        
        // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
        function showStatus(elementId, message, isError = false) {
            const el = document.getElementById(elementId);
            el.textContent = message;
            el.className = `status ${isError ? 'error' : 'success'}`;
            el.style.display = 'block';
            setTimeout(() => {
                el.style.display = 'none';
            }, 5000);
        }
        
        // Config Modal Management
        function showConfigModal() {
            const modal = document.getElementById('configModal');
            modal.classList.add('show');
            
            // Load settings and update modal
            loadSettingsForModal();
        }
        
        function hideConfigModal() {
            const modal = document.getElementById('configModal');
            modal.classList.remove('show');
        }
        
        async function loadSettingsForModal() {
            try {
                const res = await fetch(`${API_BASE}/settings`);
                const data = await res.json();
                
                // Initialize conflict policy radio buttons
                // First, clear all checked states to avoid default HTML checked attribute interfering
                document.querySelectorAll('input[name="modalConflict"]').forEach(radio => {
                    radio.checked = false;
                });
                
                if (data && data !== null) {
                    // Set conflict policy from settings
                    const conflictValue = data.conflict || 'skip';
                    const conflictRadioId = `modalConflict${conflictValue.charAt(0).toUpperCase() + conflictValue.slice(1)}`;
                    const conflictRadio = document.getElementById(conflictRadioId);
                    
                    if (conflictRadio) {
                        conflictRadio.checked = true;
                    } else {
                        // Fallback to skip if not found
                        document.getElementById('modalConflictSkip').checked = true;
                    }
                    
                    // Update password dropdown
                    updateModalPasswordSelectDropdown();
                } else {
                    // Default to skip if no settings
                    document.getElementById('modalConflictSkip').checked = true;
                }
            } catch (err) {
                console.error('Failed to load settings for modal:', err);
                // Clear all and default to skip on error
                document.querySelectorAll('input[name="modalConflict"]').forEach(radio => {
                    radio.checked = false;
                });
                document.getElementById('modalConflictSkip').checked = true;
            }
        }
        
        // Bind modal events
        document.getElementById('closeConfigModal').addEventListener('click', hideConfigModal);
        document.getElementById('cancelConfigBtn').addEventListener('click', hideConfigModal);
        
        // Close modal when clicking outside
        document.getElementById('configModal').addEventListener('click', (e) => {
            if (e.target.id === 'configModal') {
                hideConfigModal();
            }
        });
        
        // æ‰«æç›®å½•
        document.getElementById('scanBtn').addEventListener('click', async () => {
            const rootPath = document.getElementById('rootPath').value.trim();
            if (!rootPath) {
                showStatus('scanStatus', 'è¯·è¾“å…¥ç›®å½•è·¯å¾„', true);
                return;
            }
            
            const btn = document.getElementById('scanBtn');
            btn.disabled = true;
            btn.textContent = 'æ‰«æä¸­...';
            
            try {
                const res = await fetch(`${API_BASE}/scan`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        rootPath: rootPath,
                        recursive: true,
                        exts: ['.zip', '.cbz'],
                        ignoreDirs: ['@eaDir', '#recycle', '.Trash']
                    })
                });
                
                const data = await res.json();
                
                if (data.error) {
                    showStatus('scanStatus', data.error, true);
                    return;
                }
                
                selectedFiles = data.items || [];
                showStatus('scanStatus', `æ‰¾åˆ° ${data.total} ä¸ªæ–‡ä»¶${data.truncated ? ' (å·²æˆªæ–­ï¼Œè¶…è¿‡5000ä¸ª)' : ''}`);
                
                // æ˜¾ç¤ºæ–‡ä»¶åˆ—è¡¨
                const fileList = document.getElementById('fileList');
                const fileListContent = document.getElementById('fileListContent');
                
                if (selectedFiles.length > 0) {
                    fileList.style.display = 'block';
                    fileListContent.innerHTML = selectedFiles.slice(0, 100).map(item => `
                        <div class="file-item">
                            <div class="file-path">${escapeHtml(item.path)}</div>
                            <div class="file-size">${formatSize(item.size)}</div>
                        </div>
                    `).join('');
                    
                    if (selectedFiles.length > 100) {
                        const moreDiv = document.createElement('div');
                        moreDiv.style.cssText = 'padding: 10px; text-align: center; color: #999;';
                        moreDiv.textContent = `... è¿˜æœ‰ ${selectedFiles.length - 100} ä¸ªæ–‡ä»¶`;
                        fileListContent.appendChild(moreDiv);
                    }
                    
                    document.getElementById('createJobBtn').disabled = false;
                } else {
                    fileList.style.display = 'none';
                    document.getElementById('createJobBtn').disabled = true;
                }
                
            } catch (err) {
                showStatus('scanStatus', `æ‰«æå¤±è´¥: ${err.message}`, true);
            } finally {
                btn.disabled = false;
                btn.textContent = 'æ‰«æ';
            }
        });
        
        // Password mode change handlers (for modal)
        document.querySelectorAll('input[name="modalPasswordMode"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                const mode = e.target.value;
                document.getElementById('modalPasswordSelectGroup').style.display = mode === 'select' ? 'block' : 'none';
                document.getElementById('modalPasswordManualGroup').style.display = mode === 'manual' ? 'block' : 'none';
                document.getElementById('modalPasswordTryListHint').style.display = mode === 'try_list' ? 'block' : 'none';
                
                // Update password select dropdown when switching to select mode
                if (mode === 'select') {
                    updateModalPasswordSelectDropdown();
                }
            });
        });

        function updatePasswordSelectDropdown() {
            const dropdown = document.getElementById('passwordSelectDropdown');
            if (!dropdown) return;
            dropdown.innerHTML = '<option value="">è¯·é€‰æ‹©å¯†ç </option>';
            
            if (currentSettings && currentSettings.commonPasswords && currentSettings.commonPasswords.length > 0) {
                currentSettings.commonPasswords.forEach((pwd, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    const preview = getPasswordPreview(pwd);
                    option.textContent = `${preview} (#${index + 1})`;
                    dropdown.appendChild(option);
                });
            }
        }
        
        function updateModalPasswordSelectDropdown() {
            const dropdown = document.getElementById('modalPasswordSelectDropdown');
            if (!dropdown) return;
            dropdown.innerHTML = '<option value="">è¯·é€‰æ‹©å¯†ç </option>';
            
            if (currentSettings && currentSettings.commonPasswords && currentSettings.commonPasswords.length > 0) {
                currentSettings.commonPasswords.forEach((pwd, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    const preview = getPasswordPreview(pwd);
                    option.textContent = `${preview} (#${index + 1})`;
                    dropdown.appendChild(option);
                });
            }
        }

        // åˆ›å»ºä»»åŠ¡æŒ‰é’® - æ‰“å¼€é…ç½®å¼¹çª—
        document.getElementById('createJobBtn').addEventListener('click', () => {
            if (selectedFiles.length === 0) {
                showStatus('createJobStatus', 'è¯·å…ˆæ‰«ææ–‡ä»¶', true);
                return;
            }
            
            const rootPath = document.getElementById('rootPath').value.trim();
            if (!rootPath) {
                showStatus('createJobStatus', 'è¯·è¾“å…¥ç›®å½•è·¯å¾„', true);
                return;
            }
            
            showConfigModal();
        });
        
        // ç¡®è®¤åˆ›å»ºä»»åŠ¡ï¼ˆåœ¨å¼¹çª—ä¸­ï¼‰
        document.getElementById('confirmConfigBtn').addEventListener('click', async () => {
            if (selectedFiles.length === 0) {
                showStatus('configModalStatus', 'è¯·å…ˆæ‰«ææ–‡ä»¶', true);
                document.getElementById('configModalStatus').style.display = 'block';
                return;
            }
            
            const rootPath = document.getElementById('rootPath').value.trim();
            if (!rootPath) {
                showStatus('configModalStatus', 'è¯·è¾“å…¥ç›®å½•è·¯å¾„', true);
                document.getElementById('configModalStatus').style.display = 'block';
                return;
            }
            
            // æäº¤ä»»åŠ¡å‰å¿…é¡»ä»å·²ä¿å­˜çš„è®¾ç½®è¯»å– jobOptionsï¼ˆä¸ä» UI ä¸´æ—¶å€¼å–ï¼‰
            // å¼ºåˆ¶é‡æ–°è·å– settingsï¼Œç¡®ä¿ä½¿ç”¨æœ€æ–°ä¿å­˜çš„å€¼
            let settings;
            try {
                const settingsRes = await fetch(`${API_BASE}/settings`);
                if (!settingsRes.ok) {
                    showStatus('configModalStatus', 'æ— æ³•åŠ è½½è®¾ç½®ï¼Œè¯·å…ˆé…ç½®ä»»åŠ¡é€‰é¡¹', true);
                    document.getElementById('configModalStatus').style.display = 'block';
                    return;
                }
                settings = await settingsRes.json();
            } catch (err) {
                console.error('Failed to load settings:', err);
                showStatus('configModalStatus', 'æ— æ³•åŠ è½½è®¾ç½®ï¼Œè¯·å…ˆé…ç½®ä»»åŠ¡é€‰é¡¹', true);
                document.getElementById('configModalStatus').style.display = 'block';
                return;
            }
            
            // ä¸¥æ ¼æ ¡éªŒï¼šä» settings è§£æ jobOptionsï¼Œç¼ºå¤±ä»»æ„å­—æ®µåˆ™é˜»æ–­æäº¤
            if (!settings || typeof settings !== 'object') {
                showStatus('configModalStatus', 'è®¾ç½®æœªé…ç½®ï¼Œè¯·å…ˆå‰å¾€è®¾ç½®é¡µé¢å®Œæˆé…ç½®å¹¶ä¿å­˜', true);
                document.getElementById('configModalStatus').style.display = 'block';
                return;
            }
            
            // è§£æ settings ä¸º jobOptionsï¼ˆå­—æ®µæ˜ å°„ï¼šsettings.conflict -> jobOptions.conflictPolicyï¼‰
            // è·å–å¼¹çª—ä¸­é€‰æ‹©çš„å†²çªç­–ç•¥ï¼ˆloadSettingsForModal å·²æ ¹æ®è®¾ç½®åˆå§‹åŒ–ï¼Œæ‰€ä»¥è¿™é‡Œè·å–åˆ°çš„åº”è¯¥æ˜¯è®¾ç½®ä¸­çš„å€¼ï¼Œé™¤éç”¨æˆ·æ‰‹åŠ¨æ”¹å˜äº†ï¼‰
            const modalConflict = document.querySelector('input[name="modalConflict"]:checked')?.value;
            // ä¼˜å…ˆä½¿ç”¨å¼¹çª—ä¸­é€‰æ‹©çš„å€¼ï¼ˆå¦‚æœç”¨æˆ·æ‰‹åŠ¨é€‰æ‹©äº†ï¼Œä¼šä½¿ç”¨ç”¨æˆ·é€‰æ‹©çš„å€¼ï¼‰
            // å¦åˆ™ä½¿ç”¨è®¾ç½®ä¸­çš„é»˜è®¤å€¼ï¼ˆç¡®ä¿å…¨å±€è®¾ç½®ç”Ÿæ•ˆï¼‰
            // æ³¨æ„ï¼šç”±äº loadSettingsForModal å·²ç»æ ¹æ®è®¾ç½®åˆå§‹åŒ–äº†å•é€‰æŒ‰é’®ï¼Œæ‰€ä»¥ modalConflict åº”è¯¥æ€»æ˜¯æœ‰å€¼
            const conflictPolicy = modalConflict || settings.conflict;
            const outputMode = settings.outputMode;
            const zipSlipPolicy = settings.zipSlipPolicy;
            
            // æ ¡éªŒï¼šä»»æ„å­—æ®µç¼ºå¤±/ä¸ºç©ºåˆ™é˜»æ–­
            const missingFields = [];
            if (!conflictPolicy || conflictPolicy === null || conflictPolicy === '') {
                missingFields.push('conflictPolicy (å†²çªç­–ç•¥)');
            }
            if (!outputMode || outputMode === null || outputMode === '') {
                missingFields.push('outputMode (è¾“å‡ºæ–¹å¼)');
            }
            if (!zipSlipPolicy || zipSlipPolicy === null || zipSlipPolicy === '') {
                missingFields.push('zipSlipPolicy (è·¯å¾„ç©¿è¶Šç­–ç•¥)');
            }
            
            if (missingFields.length > 0) {
                const missingList = missingFields.join('ã€');
                showStatus('configModalStatus', `è®¾ç½®ä¸å®Œæ•´ï¼Œç¼ºå°‘å¿…å¡«å­—æ®µï¼š${missingList}ã€‚è¯·å‰å¾€è®¾ç½®é¡µé¢å®Œæˆé…ç½®å¹¶ä¿å­˜ã€‚`, true);
                document.getElementById('configModalStatus').style.display = 'block';
                return;
            }
            
            // Get password mode and validate
            const passwordMode = document.querySelector('input[name="modalPasswordMode"]:checked').value;
            const jobOptions = {
                conflictPolicy: conflictPolicy,
                outputMode: outputMode,
                zipSlipPolicy: zipSlipPolicy
            };
            
            // Add password fields based on mode
            if (passwordMode !== 'none') {
                jobOptions.passwordMode = passwordMode;
                
                if (passwordMode === 'select') {
                    const passwordRefIndex = parseInt(document.getElementById('modalPasswordSelectDropdown').value);
                    if (isNaN(passwordRefIndex) || passwordRefIndex < 0) {
                        showStatus('configModalStatus', 'è¯·é€‰æ‹©å¸¸ç”¨å¯†ç ', true);
                        document.getElementById('configModalStatus').style.display = 'block';
                        return;
                    }
                    jobOptions.passwordRefIndex = passwordRefIndex;
                    // Log selected password preview (for user confirmation)
                    const selectedPwd = settings.commonPasswords?.[passwordRefIndex];
                    if (selectedPwd) {
                        const preview = getPasswordPreview(selectedPwd);
                        console.log('[job] Selected password preview:', `${preview} (#${passwordRefIndex + 1})`);
                    }
                } else if (passwordMode === 'manual') {
                    const passwordValue = document.getElementById('modalPasswordManualInput').value.trim();
                    if (!passwordValue) {
                        showStatus('configModalStatus', 'è¯·è¾“å…¥è§£å‹å¯†ç ', true);
                        document.getElementById('configModalStatus').style.display = 'block';
                        return;
                    }
                    jobOptions.passwordValue = passwordValue;
                } else if (passwordMode === 'try_list') {
                    const commonPasswords = settings.commonPasswords || [];
                    if (commonPasswords.length === 0) {
                        showStatus('configModalStatus', 'å¸¸ç”¨å¯†ç åˆ—è¡¨ä¸ºç©ºï¼Œè¯·å‰å¾€è®¾ç½®é¡µé¢æ·»åŠ å¯†ç ', true);
                        document.getElementById('configModalStatus').style.display = 'block';
                        return;
                    }
                    jobOptions.passwordTryOrder = 'as_is';
                }
            }
            
            const btn = document.getElementById('confirmConfigBtn');
            btn.disabled = true;
            btn.textContent = 'åˆ›å»ºä¸­...';
            
            try {
                // è°ƒç”¨ /api/job-submissions æ¥å£
                // jobOptions å¿…é¡»ä»å·²ä¿å­˜çš„ settings ä¸­è§£æï¼ŒåŸæ ·æäº¤
                const res = await fetch(`${API_BASE}/job-submissions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        rootPath: rootPath,
                        items: selectedFiles.map(f => f.path),
                        jobOptions: jobOptions
                    })
                });
                
                const data = await res.json();
                
                if (!res.ok || data.error) {
                    // å¤„ç†é”™è¯¯å“åº”ï¼Œæ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
                    let errorMsg = data.error || 'Unknown error';
                    if (data.missing && Array.isArray(data.missing)) {
                        errorMsg = `ç¼ºå°‘å¿…å¡«å­—æ®µ: ${data.missing.join(', ')}`;
                    } else if (data.message) {
                        errorMsg = data.message;
                    }
                    showStatus('configModalStatus', errorMsg, true);
                    document.getElementById('configModalStatus').style.display = 'block';
                    return;
                }
                
                showStatus('createJobStatus', `ä»»åŠ¡åˆ›å»ºæˆåŠŸï¼ŒID: ${data.jobId}`);
                hideConfigModal();
                
                // å¼€å§‹è½®è¯¢ä»»åŠ¡åˆ—è¡¨
                startPolling();
                
            } catch (err) {
                showStatus('configModalStatus', `åˆ›å»ºå¤±è´¥: ${err.message}`, true);
                document.getElementById('configModalStatus').style.display = 'block';
            } finally {
                btn.disabled = false;
                btn.textContent = 'ç¡®è®¤å¼€å§‹';
            }
        });
        
        // è·å–ä»»åŠ¡åˆ—è¡¨
        async function fetchJobs() {
            try {
                const res = await fetch(`${API_BASE}/jobs`);
                const data = await res.json();
                
                if (data.error) {
                    console.error('Fetch jobs error:', data.error);
                    return;
                }
                
                renderJobs(data.jobs || []);
            } catch (err) {
                console.error('Fetch jobs failed:', err);
            }
        }
        
        // æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨
        function renderJobs(jobs) {
            const jobsList = document.getElementById('jobsList');
            
            // ä¿å­˜å½“å‰å±•å¼€çš„æ—¥å¿—åŒºåŸŸçŠ¶æ€ï¼ˆåœ¨é‡æ–°æ¸²æŸ“å‰ï¼‰
            const expandedLogs = new Set();
            jobsList.querySelectorAll('.job-logs.show').forEach(logsEl => {
                const jobId = logsEl.id.replace('job-logs-', '');
                expandedLogs.add(jobId);
            });
            
            if (jobs.length === 0) {
                jobsList.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">æš‚æ— ä»»åŠ¡</div>';
                return;
            }
            
            // åˆ¤æ–­ä»»åŠ¡æ˜¯å¦å¯åˆ é™¤ï¼ˆä»…ç»ˆæ€ï¼šcompleted/failed/canceledï¼‰
            const isDeletable = (status) => {
                const terminalStatuses = ['completed', 'failed', 'canceled'];
                return terminalStatuses.includes(status);
            };
            
            jobsList.innerHTML = jobs.map(job => {
                const statusClass = job.status || 'pending';
                const progress = job.total > 0 
                    ? `æˆåŠŸ: ${job.success || 0} / å¤±è´¥: ${job.failed || 0} / è·³è¿‡: ${job.skipped || 0} / æ€»è®¡: ${job.total}`
                    : 'ç­‰å¾…ä¸­...';
                
                const canDelete = isDeletable(job.status);
                const canRetry = job.status === 'failed';
                const retryFromInfo = job.retryFromJobId ? ` (é‡è¯•è‡ªä»»åŠ¡ #${escapeHtml(String(job.retryFromJobId))})` : '';
                
                // è®¡ç®—è¿›åº¦ç™¾åˆ†æ¯”
                const total = job.total || 0;
                const done = (job.success || 0) + (job.failed || 0) + (job.skipped || 0) + (job.canceled || 0);
                const percent = total > 0 ? Math.round((done / total) * 100) : 0;
                const isRunning = job.status === 'running';
                
                return `
                    <div class="job-item" data-job-id="${escapeHtml(String(job.id))}">
                        <div class="job-header">
                            <span class="job-id">ä»»åŠ¡ #${escapeHtml(String(job.id))}${escapeHtml(retryFromInfo)}</span>
                            <span class="job-status ${escapeHtml(statusClass)}">${escapeHtml(getStatusText(job.status))}</span>
                            <div style="display: flex; gap: 5px;">
                                ${canRetry 
                                    ? `<button class="btn-retry-job" data-job-id="${job.id}" title="é‡è¯•ä»»åŠ¡" style="background: #f39c12; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px;">é‡è¯•</button>`
                                    : ''
                                }
                                ${canDelete 
                                    ? `<button class="btn-delete-job" data-job-id="${job.id}" title="åˆ é™¤ä»»åŠ¡">åˆ é™¤</button>`
                                    : `<button class="btn-delete-job" disabled title="è¿›è¡Œä¸­çš„ä»»åŠ¡æ— æ³•åˆ é™¤">åˆ é™¤</button>`
                                }
                            </div>
                        </div>
                        <div class="job-info">
                            <div>è·¯å¾„: ${escapeHtml(job.rootPath || '')}</div>
                            <div>${escapeHtml(progress)}</div>
                            <div>åˆ›å»ºæ—¶é—´: ${escapeHtml(formatTime(job.createdAt))}</div>
                            ${job.startedAt ? `<div>å¼€å§‹æ—¶é—´: ${escapeHtml(formatTime(job.startedAt))}</div>` : ''}
                            ${job.endedAt ? `<div>ç»“æŸæ—¶é—´: ${escapeHtml(formatTime(job.endedAt))}</div>` : ''}
                            ${job.lastError ? `<div style="color: #e74c3c; margin-top: 5px;">é”™è¯¯: ${escapeHtml(job.lastError)}</div>` : ''}
                        </div>
                        ${total > 0 ? `
                            <div class="job-progress-container">
                                <div class="job-progress-bar">
                                    <div class="job-progress-fill ${isRunning ? 'running' : ''}" style="width: ${percent}%;"></div>
                                </div>
                            </div>
                        ` : ''}
                        <div class="job-actions">
                            <button class="btn-view-logs" data-job-id="${job.id}">æŸ¥çœ‹æ—¥å¿—</button>
                        </div>
                        <div class="job-logs" id="job-logs-${job.id}"></div>
                    </div>
                `;
            }).join('');
            
            // ç»‘å®šåˆ é™¤æŒ‰é’®äº‹ä»¶
            jobsList.querySelectorAll('.btn-delete-job:not([disabled])').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const jobId = parseInt(e.target.getAttribute('data-job-id'));
                    await handleDeleteJob(jobId);
                });
            });

            // ç»‘å®šé‡è¯•æŒ‰é’®äº‹ä»¶
            jobsList.querySelectorAll('.btn-retry-job').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const jobId = parseInt(e.target.getAttribute('data-job-id'));
                    await handleRetryJob(jobId);
                });
            });
            
            // ç»‘å®šæŸ¥çœ‹æ—¥å¿—æŒ‰é’®äº‹ä»¶
            jobsList.querySelectorAll('.btn-view-logs').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé¿å…è§¦å‘å…¶ä»–äº‹ä»¶
                    e.stopPropagation();
                    e.preventDefault();
                    
                    const jobId = e.target.getAttribute('data-job-id');
                    const logsEl = document.getElementById(`job-logs-${jobId}`);
                    
                    if (logsEl.classList.contains('show')) {
                        // éšè—æ—¥å¿—
                        logsEl.classList.remove('show');
                        e.target.textContent = 'æŸ¥çœ‹æ—¥å¿—';
                    } else {
                        // å±•å¼€æ—¥å¿—
                        // æ£€æŸ¥ç¼“å­˜ï¼ˆä»…å¯¹å·²å®Œæˆçš„ä»»åŠ¡ä½¿ç”¨ç¼“å­˜ï¼‰
                        const job = jobs.find(j => j.id == jobId);
                        const isJobFinished = job && ['completed', 'failed', 'canceled'].includes(job.status);
                        
                        if (isJobFinished && jobLogCache[jobId]) {
                            // ä½¿ç”¨ç¼“å­˜çš„æ—¥å¿—
                            logsEl.textContent = jobLogCache[jobId];
                            logsEl.classList.add('show');
                            e.target.textContent = 'éšè—æ—¥å¿—';
                            logsEl.scrollTop = logsEl.scrollHeight;
                        } else {
                            // ä»åç«¯åŠ è½½æ—¥å¿—
                            e.target.disabled = true;
                            e.target.textContent = 'åŠ è½½ä¸­...';
                            logsEl.textContent = 'Loading log...';
                            logsEl.classList.add('show');
                            
                            try {
                                // ä»åç«¯è·å–æ—¥å¿—
                                const res = await fetch(`${API_BASE}/jobs/${jobId}/log`);
                                const data = await res.json();
                                
                                if (res.ok && data.content !== undefined) {
                                    const logContent = data.content || 'No log available';
                                    logsEl.textContent = logContent;
                                    
                                    // ç¼“å­˜æ—¥å¿—ï¼ˆä»…å¯¹å·²å®Œæˆçš„ä»»åŠ¡ï¼‰
                                    if (isJobFinished) {
                                        jobLogCache[jobId] = logContent;
                                    }
                                } else {
                                    logsEl.textContent = data.error || 'No log available';
                                }
                                
                                // æ»šåŠ¨åˆ°åº•éƒ¨
                                logsEl.scrollTop = logsEl.scrollHeight;
                            } catch (err) {
                                logsEl.textContent = `Failed to load log: ${err.message}`;
                            } finally {
                                e.target.disabled = false;
                                e.target.textContent = 'éšè—æ—¥å¿—';
                            }
                        }
                    }
                });
            });
            
            // æ¢å¤ä¹‹å‰å±•å¼€çš„æ—¥å¿—åŒºåŸŸçŠ¶æ€
            expandedLogs.forEach(jobId => {
                const logsEl = document.getElementById(`job-logs-${jobId}`);
                const btn = jobsList.querySelector(`.btn-view-logs[data-job-id="${jobId}"]`);
                
                if (logsEl && btn) {
                    // æ£€æŸ¥æ˜¯å¦æœ‰ç¼“å­˜çš„æ—¥å¿—å†…å®¹
                    const job = jobs.find(j => j.id == jobId);
                    const isJobFinished = job && ['completed', 'failed', 'canceled'].includes(job.status);
                    
                    if (isJobFinished && jobLogCache[jobId]) {
                        // æ¢å¤ç¼“å­˜çš„æ—¥å¿—
                        logsEl.textContent = jobLogCache[jobId];
                        logsEl.classList.add('show');
                        btn.textContent = 'éšè—æ—¥å¿—';
                        logsEl.scrollTop = logsEl.scrollHeight;
                    } else {
                        // å¦‚æœæ²¡æœ‰ç¼“å­˜ï¼Œé‡æ–°åŠ è½½
                        btn.disabled = true;
                        btn.textContent = 'åŠ è½½ä¸­...';
                        logsEl.textContent = 'Loading log...';
                        logsEl.classList.add('show');
                        
                        fetch(`${API_BASE}/jobs/${jobId}/log`)
                            .then(res => res.json().then(data => ({ res, data })))
                            .then(({ res, data }) => {
                                if (res.ok && data.content !== undefined) {
                                    const logContent = data.content || 'No log available';
                                    logsEl.textContent = logContent;
                                    
                                    if (isJobFinished) {
                                        jobLogCache[jobId] = logContent;
                                    }
                                } else {
                                    logsEl.textContent = data.error || 'No log available';
                                }
                                logsEl.scrollTop = logsEl.scrollHeight;
                            })
                            .catch(err => {
                                logsEl.textContent = `Failed to load log: ${err.message}`;
                            })
                            .finally(() => {
                                btn.disabled = false;
                                btn.textContent = 'éšè—æ—¥å¿—';
                            });
                    }
                }
            });
        }
        
        // API client: åˆ é™¤å•ä¸ªä»»åŠ¡
        async function deleteJob(jobId) {
            const res = await fetch(`${API_BASE}/jobs/${jobId}`, {
                method: 'DELETE'
            });
            
            const data = await res.json();
            
            if (!res.ok) {
                const error = new Error(data.message || data.error || 'åˆ é™¤å¤±è´¥');
                error.status = res.status;
                throw error;
            }
            
            return data;
        }
        
        // API client: æ¸…é™¤å¤±è´¥ä»»åŠ¡
        async function clearFailedJobs() {
            const res = await fetch(`${API_BASE}/jobs/clear-failed`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({})
            });
            
            const data = await res.json();
            
            if (!res.ok) {
                const error = new Error(data.message || data.error || 'æ¸…é™¤å¤±è´¥');
                error.status = res.status;
                throw error;
            }
            
            return data;
        }
        
        // åˆ é™¤å•ä¸ªä»»åŠ¡ï¼ˆUI handlerï¼‰
        async function handleDeleteJob(jobId) {
            if (!confirm(`ç¡®è®¤åˆ é™¤ä»»åŠ¡ #${jobId}ï¼Ÿ\nä»…åˆ é™¤è®°å½•ï¼Œä¸ä¼šåˆ é™¤å·²è§£å‹çš„æ–‡ä»¶ã€‚`)) {
                return;
            }
            
            try {
                await deleteJob(jobId);
                // æˆåŠŸåˆ é™¤ï¼Œåˆ·æ–°åˆ—è¡¨
                showStatus('createJobStatus', `ä»»åŠ¡ #${jobId} å·²åˆ é™¤`, false);
                await fetchJobs();
            } catch (err) {
                // é”™è¯¯åŸæ ·æŠ›å‡ºï¼Œtoast å±•ç¤ºæœåŠ¡ç«¯ message
                const errorMsg = err.message || 'åˆ é™¤å¤±è´¥';
                showStatus('createJobStatus', errorMsg, true);
                
                // å¦‚æœæ˜¯404ï¼Œåˆ·æ–°åˆ—è¡¨
                if (err.status === 404) {
                    await fetchJobs();
                }
            }
        }
        
        // æ¸…é™¤å¤±è´¥ä»»åŠ¡ï¼ˆUI handlerï¼‰
        async function handleClearFailed() {
            if (!confirm('ç¡®è®¤æ¸…é™¤æ‰€æœ‰å¤±è´¥ä»»åŠ¡ï¼Ÿ\nå°†åˆ é™¤æ‰€æœ‰ failed çŠ¶æ€ä»»åŠ¡ï¼Œæ— æ³•æ¢å¤ã€‚\nä»…åˆ é™¤è®°å½•ï¼Œä¸ä¼šåˆ é™¤å·²è§£å‹çš„æ–‡ä»¶ã€‚')) {
                return;
            }
            
            try {
                const result = await clearFailedJobs();
                // æˆåŠŸï¼šæ˜¾ç¤º deletedCount
                showStatus('createJobStatus', `å·²æ¸…é™¤ ${result.deletedCount || 0} ä¸ªå¤±è´¥ä»»åŠ¡`, false);
                // ç«‹å³åˆ·æ–°åˆ—è¡¨
                await fetchJobs();
            } catch (err) {
                // é”™è¯¯åŸæ ·æŠ›å‡ºï¼Œtoast å±•ç¤ºæœåŠ¡ç«¯ message
                const errorMsg = err.message || 'æ¸…é™¤å¤±è´¥';
                showStatus('createJobStatus', errorMsg, true);
            }
        }

        // Retry job modal management
        let currentRetryJobId = null;

        function showRetryModal(jobId) {
            currentRetryJobId = jobId;
            document.getElementById('retryJobModal').style.display = 'flex';
            document.getElementById('retryJobError').style.display = 'none';
            
            // Reset form
            document.getElementById('retryPasswordNone').checked = true;
            document.getElementById('retryPasswordSelectGroup').style.display = 'none';
            document.getElementById('retryPasswordManualGroup').style.display = 'none';
            document.getElementById('retryPasswordTryListHint').style.display = 'none';
            document.getElementById('retryPasswordSelectDropdown').value = '';
            document.getElementById('retryPasswordManualInput').value = '';
            
            // Update password dropdown
            updateRetryPasswordSelectDropdown();
        }

        function hideRetryModal() {
            document.getElementById('retryJobModal').style.display = 'none';
            currentRetryJobId = null;
        }

        function updateRetryPasswordSelectDropdown() {
            const dropdown = document.getElementById('retryPasswordSelectDropdown');
            dropdown.innerHTML = '<option value="">è¯·é€‰æ‹©å¯†ç </option>';
            
            if (currentSettings && currentSettings.commonPasswords && currentSettings.commonPasswords.length > 0) {
                currentSettings.commonPasswords.forEach((pwd, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    const preview = getPasswordPreview(pwd);
                    option.textContent = `${preview} (#${index + 1})`;
                    dropdown.appendChild(option);
                });
            }
        }

        // Retry password mode change handlers
        document.querySelectorAll('input[name="retryPasswordMode"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                const mode = e.target.value;
                document.getElementById('retryPasswordSelectGroup').style.display = mode === 'select' ? 'block' : 'none';
                document.getElementById('retryPasswordManualGroup').style.display = mode === 'manual' ? 'block' : 'none';
                document.getElementById('retryPasswordTryListHint').style.display = mode === 'try_list' ? 'block' : 'none';
                
                if (mode === 'select') {
                    updateRetryPasswordSelectDropdown();
                }
            });
        });

        // å®‰å…¨åœ°æ·»åŠ äº‹ä»¶ç›‘å¬å™¨ï¼ˆå¦‚æœå…ƒç´ å­˜åœ¨ï¼‰
        const closeRetryModalEl = document.getElementById('closeRetryModal');
        const cancelRetryBtnEl = document.getElementById('cancelRetryBtn');
        const confirmRetryBtnEl = document.getElementById('confirmRetryBtn');
        
        if (closeRetryModalEl) {
            closeRetryModalEl.addEventListener('click', hideRetryModal);
        }
        if (cancelRetryBtnEl) {
            cancelRetryBtnEl.addEventListener('click', hideRetryModal);
        }

        if (confirmRetryBtnEl) {
            confirmRetryBtnEl.addEventListener('click', async () => {
            if (!currentRetryJobId) {
                return;
            }

            const passwordMode = document.querySelector('input[name="retryPasswordMode"]:checked').value;
            const retryBody = { passwordMode };

            // Validate and add password fields
            if (passwordMode === 'select') {
                const passwordRefIndex = parseInt(document.getElementById('retryPasswordSelectDropdown').value);
                if (isNaN(passwordRefIndex) || passwordRefIndex < 0) {
                    document.getElementById('retryJobError').textContent = 'è¯·é€‰æ‹©å¸¸ç”¨å¯†ç ';
                    document.getElementById('retryJobError').style.display = 'block';
                    return;
                }
                retryBody.passwordRefIndex = passwordRefIndex;
                // Log selected password preview (for user confirmation)
                const selectedPwd = currentSettings?.commonPasswords?.[passwordRefIndex];
                if (selectedPwd) {
                    const preview = getPasswordPreview(selectedPwd);
                    console.log('[retry] Selected password preview:', `${preview} (#${passwordRefIndex + 1})`);
                }
            } else if (passwordMode === 'manual') {
                const passwordValue = document.getElementById('retryPasswordManualInput').value.trim();
                if (!passwordValue) {
                    document.getElementById('retryJobError').textContent = 'è¯·è¾“å…¥è§£å‹å¯†ç ';
                    document.getElementById('retryJobError').style.display = 'block';
                    return;
                }
                retryBody.passwordValue = passwordValue;
            } else if (passwordMode === 'try_list') {
                const commonPasswords = currentSettings?.commonPasswords || [];
                if (commonPasswords.length === 0) {
                    document.getElementById('retryJobError').textContent = 'å¸¸ç”¨å¯†ç åˆ—è¡¨ä¸ºç©ºï¼Œè¯·å‰å¾€è®¾ç½®é¡µé¢æ·»åŠ å¯†ç ';
                    document.getElementById('retryJobError').style.display = 'block';
                    return;
                }
            }

            // Disable button
            const btn = document.getElementById('confirmRetryBtn');
            btn.disabled = true;
            btn.textContent = 'é‡è¯•ä¸­...';

            try {
                const res = await fetch(`${API_BASE}/jobs/${currentRetryJobId}/retry`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(retryBody)
                });

                const data = await res.json();

                if (!res.ok || data.error) {
                    const errorMsg = data.error || data.message || 'é‡è¯•å¤±è´¥';
                    document.getElementById('retryJobError').textContent = errorMsg;
                    document.getElementById('retryJobError').style.display = 'block';
                    return;
                }

                // Success
                hideRetryModal();
                showStatus('createJobStatus', `å·²åˆ›å»ºé‡è¯•ä»»åŠ¡ #${data.jobId}`, false);
                await fetchJobs();
            } catch (err) {
                document.getElementById('retryJobError').textContent = `é‡è¯•å¤±è´¥: ${err.message}`;
                document.getElementById('retryJobError').style.display = 'block';
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = 'ç¡®è®¤é‡è¯•';
                }
            }
            });
        }

        // Retry job handler
        async function handleRetryJob(jobId) {
            // Load settings first to ensure password dropdown is populated
            try {
                const settingsRes = await fetch(`${API_BASE}/settings`);
                if (settingsRes.ok) {
                    const settings = await settingsRes.json();
                    currentSettings = settings;
                }
            } catch (err) {
                console.error('Failed to load settings for retry:', err);
            }

            showRetryModal(jobId);
        }
        
        // å¼€å§‹è½®è¯¢
        function startPolling() {
            if (pollInterval) return;
            
            fetchJobs(); // ç«‹å³è·å–ä¸€æ¬¡
            pollInterval = setInterval(fetchJobs, 2000);
        }
        
        // åœæ­¢è½®è¯¢
        function stopPolling() {
            if (pollInterval) {
                clearInterval(pollInterval);
                pollInterval = null;
            }
        }
        
        // å·¥å…·å‡½æ•°
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function formatSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
            if (bytes < 1024 * 1024 * 1024) return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
            return (bytes / (1024 * 1024 * 1024)).toFixed(2) + ' GB';
        }
        
        function formatTime(timestamp) {
            if (!timestamp) return '';
            return new Date(timestamp).toLocaleString('zh-CN');
        }
        
        function getStatusText(status) {
            const map = {
                'pending': 'ç­‰å¾…ä¸­',
                'running': 'è¿è¡Œä¸­',
                'success': 'æˆåŠŸ',
                'failed': 'å¤±è´¥',
                'skipped': 'è·³è¿‡',
                'canceled': 'å·²å–æ¶ˆ',
                'completed': 'å·²å®Œæˆ',
                'paused': 'å·²æš‚åœ',
                'draft': 'è‰ç¨¿',
                'queued': 'é˜Ÿåˆ—ä¸­',
                'pausing': 'æš‚åœä¸­',
                'canceling': 'å–æ¶ˆä¸­'
            };
            return map[status] || status;
        }
        
        // ç»‘å®šæ¸…ç©ºå¤±è´¥æŒ‰é’®
        document.getElementById('clearFailedBtn').addEventListener('click', handleClearFailed);
        
        // ========== Directory Selector ==========
        let currentDirPath = '/';
        let dirSelectorLoading = false;
        
        // Directory selector modal management
        function showDirSelector() {
            const modal = document.getElementById('dirSelectorModal');
            if (!modal) return;
            modal.style.display = 'flex';
            currentDirPath = '/';
            loadDirRoots();
        }
        
        function hideDirSelector() {
            const modal = document.getElementById('dirSelectorModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        async function loadDirRoots() {
            if (dirSelectorLoading) return;
            dirSelectorLoading = true;
            
            const loadingEl = document.getElementById('dirSelectorLoading');
            const errorEl = document.getElementById('dirSelectorError');
            const listEl = document.getElementById('dirSelectorList');
            const pathEl = document.getElementById('dirSelectorCurrentPath');
            
            if (loadingEl) loadingEl.style.display = 'block';
            if (errorEl) errorEl.style.display = 'none';
            if (listEl) listEl.innerHTML = '';
            
            try {
                const res = await fetch(`${API_BASE}/fs/roots`);
                const data = await res.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                if (data.roots && data.roots.length > 0) {
                    // Sort roots by source priority (already sorted by backend, but ensure frontend respects it)
                    const sortedRoots = [...data.roots].sort((a, b) => {
                        const sourcePriority = { 'data-share': 0, 'trim': 1, 'probe': 2, 'fallback': 3 };
                        const priorityA = sourcePriority[a.source] ?? 99;
                        const priorityB = sourcePriority[b.source] ?? 99;
                        if (priorityA !== priorityB) {
                            return priorityA - priorityB;
                        }
                        return a.path.localeCompare(b.path);
                    });
                    
                    renderDirList(sortedRoots.map((r) => ({
                        name: r.label,
                        path: r.path,
                        isDir: true,
                        source: r.source
                    })));
                    currentDirPath = '/';
                    if (pathEl) pathEl.textContent = 'Root';
                } else {
                    if (listEl) listEl.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">æ²¡æœ‰å¯è®¿é—®çš„æ ¹ç›®å½•</div>';
                }
            } catch (err) {
                if (errorEl) {
                    errorEl.textContent = `åŠ è½½å¤±è´¥: ${err.message}`;
                    errorEl.style.display = 'block';
                }
            } finally {
                if (loadingEl) loadingEl.style.display = 'none';
                dirSelectorLoading = false;
            }
        }
        
        async function loadDirList(path) {
            if (dirSelectorLoading) return;
            dirSelectorLoading = true;
            
            const loadingEl = document.getElementById('dirSelectorLoading');
            const errorEl = document.getElementById('dirSelectorError');
            const listEl = document.getElementById('dirSelectorList');
            const pathEl = document.getElementById('dirSelectorCurrentPath');
            
            if (loadingEl) loadingEl.style.display = 'block';
            if (errorEl) errorEl.style.display = 'none';
            if (listEl) listEl.innerHTML = '';
            
            try {
                const res = await fetch(`${API_BASE}/fs/list?path=${encodeURIComponent(path)}`);
                const data = await res.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                currentDirPath = data.path;
                if (pathEl) pathEl.textContent = data.path;
                
                if (data.items && data.items.length > 0) {
                    renderDirList(data.items.filter((item) => item.isDir));
                } else {
                    if (listEl) listEl.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">æ­¤ç›®å½•ä¸ºç©º</div>';
                }
            } catch (err) {
                if (errorEl) {
                    errorEl.textContent = `åŠ è½½å¤±è´¥: ${err.message}`;
                    errorEl.style.display = 'block';
                }
            } finally {
                if (loadingEl) loadingEl.style.display = 'none';
                dirSelectorLoading = false;
            }
        }
        
        function renderDirList(items) {
            const listEl = document.getElementById('dirSelectorList');
            if (!listEl) return;
            
            if (items.length === 0) {
                listEl.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">æ­¤ç›®å½•ä¸ºç©º</div>';
                return;
            }
            
            listEl.innerHTML = items.map(item => {
                const itemPath = escapeHtml(item.path);
                const itemName = escapeHtml(item.name);
                return '<div class="dir-item" data-path="' + itemPath + '" style="padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; align-items: center; gap: 10px;" onmouseover="this.style.background=\'#f5f5f5\'" onmouseout="this.style.background=\'white\'">' +
                    '<span style="font-size: 18px;">ğŸ“</span>' +
                    '<span style="flex: 1;">' + itemName + '</span>' +
                    '</div>';
            }).join('');
            
            // Add click handlers
            listEl.querySelectorAll('.dir-item').forEach(el => {
                el.addEventListener('click', () => {
                    const path = el.getAttribute('data-path');
                    if (path) {
                        loadDirList(path);
                    }
                });
            });
        }
        
        function goToParentDir() {
            if (currentDirPath === '/' || currentDirPath === '') {
                loadDirRoots();
                return;
            }
            const parentPath = getParentPath(currentDirPath);
            if (parentPath === currentDirPath) {
                loadDirRoots();
            } else {
                loadDirList(parentPath);
            }
        }
        
        function getParentPath(p) {
            const normalized = p.replace(/\\/g, '/');
            const parts = normalized.split('/').filter(x => x);
            if (parts.length === 0) return '/';
            if (parts.length === 1) return '/';
            return '/' + parts.slice(0, -1).join('/');
        }
        
        function selectCurrentDir() {
            const rootPathInput = document.getElementById('rootPath');
            if (rootPathInput) {
                rootPathInput.value = currentDirPath;
            }
            hideDirSelector();
        }
        
        // Bind directory selector events
        const selectDirBtn = document.getElementById('selectDirBtn');
        if (selectDirBtn) {
            selectDirBtn.addEventListener('click', showDirSelector);
        }
        
        const closeDirSelector = document.getElementById('closeDirSelector');
        if (closeDirSelector) {
            closeDirSelector.addEventListener('click', hideDirSelector);
        }
        
        const dirSelectorCancel = document.getElementById('dirSelectorCancel');
        if (dirSelectorCancel) {
            dirSelectorCancel.addEventListener('click', hideDirSelector);
        }
        
        const dirSelectorConfirm = document.getElementById('dirSelectorConfirm');
        if (dirSelectorConfirm) {
            dirSelectorConfirm.addEventListener('click', selectCurrentDir);
        }
        
        const dirSelectorGoRoot = document.getElementById('dirSelectorGoRoot');
        if (dirSelectorGoRoot) {
            dirSelectorGoRoot.addEventListener('click', loadDirRoots);
        }
        
        const dirSelectorGoUp = document.getElementById('dirSelectorGoUp');
        if (dirSelectorGoUp) {
            dirSelectorGoUp.addEventListener('click', goToParentDir);
        }
        
        // åŠ è½½ç‰ˆæœ¬å·
        async function loadVersion() {
            try {
                const res = await fetch('/version.json');
                if (res.ok) {
                    const data = await res.json();
                    document.getElementById('versionText').textContent = data.version || 'unknown';
                } else {
                    document.getElementById('versionText').textContent = 'unknown';
                }
            } catch (err) {
                console.error('Failed to load version:', err);
                document.getElementById('versionText').textContent = 'unknown';
            }
        }
        
        // ========== Dark Mode ==========
        function initDarkMode() {
            // æ£€æŸ¥ localStorage ä¸­çš„ç”¨æˆ·åå¥½
            const savedMode = localStorage.getItem('darkMode');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            
            let isDarkMode = false;
            
            if (savedMode !== null) {
                // ç”¨æˆ·å·²æ‰‹åŠ¨è®¾ç½®è¿‡
                isDarkMode = savedMode === 'true';
            } else {
                // é»˜è®¤è·Ÿéšç³»ç»Ÿè®¾ç½®
                isDarkMode = prefersDark;
            }
            
            applyDarkMode(isDarkMode);
            
            // ç›‘å¬ç³»ç»Ÿä¸»é¢˜å˜åŒ–ï¼ˆä»…åœ¨æœªæ‰‹åŠ¨è®¾ç½®æ—¶ï¼‰
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
                if (localStorage.getItem('darkMode') === null) {
                    applyDarkMode(e.matches);
                }
            });
        }
        
        function applyDarkMode(isDark) {
            if (isDark) {
                document.body.classList.add('dark-mode');
                document.getElementById('darkModeIcon').textContent = 'â˜€ï¸';
                document.getElementById('darkModeText').textContent = 'æµ…è‰²æ¨¡å¼';
            } else {
                document.body.classList.remove('dark-mode');
                document.getElementById('darkModeIcon').textContent = 'ğŸŒ™';
                document.getElementById('darkModeText').textContent = 'æš—é»‘æ¨¡å¼';
            }
        }
        
        function toggleDarkMode() {
            const isDark = document.body.classList.contains('dark-mode');
            const newMode = !isDark;
            applyDarkMode(newMode);
            localStorage.setItem('darkMode', newMode.toString());
        }
        
        // ç»‘å®šæš—é»‘æ¨¡å¼åˆ‡æ¢æŒ‰é’®
        document.getElementById('darkModeToggle').addEventListener('click', toggleDarkMode);
        
        // åˆå§‹åŒ–æš—é»‘æ¨¡å¼
        initDarkMode();
        
        // åˆå§‹åŒ–
        loadVersion();
        checkHealth().then(ok => {
            if (ok) {
                startPolling();
            } else {
                showStatus('scanStatus', 'æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥æœåŠ¡æ˜¯å¦è¿è¡Œ', true);
            }
        });
        
        // é¡µé¢å¸è½½æ—¶åœæ­¢è½®è¯¢
        window.addEventListener('beforeunload', stopPolling);

        // ========== Job Detail Page ==========
        let jobDetailPollInterval = null;
        let currentJobId = null;
        let jobDetailData = null;

        // Back button
        document.getElementById('backToJobsBtn').addEventListener('click', () => {
            window.location.hash = '';
            showPage('pageHome');
        });

        // API: Fetch job detail
        async function fetchJobDetail(jobId) {
            try {
                const res = await fetch(`${API_BASE}/jobs/${jobId}`);
                const data = await res.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                return data;
            } catch (err) {
                throw err;
            }
        }

        // Load job detail
        async function loadJobDetail(jobId) {
            currentJobId = jobId;
            const errorBanner = document.getElementById('jobDetailError');
            const content = document.getElementById('jobDetailContent');
            
            try {
                const data = await fetchJobDetail(jobId);
                jobDetailData = data;
                
                errorBanner.classList.remove('show');
                content.style.display = 'block';
                
                renderJobDetail(data.job, data.items);
                
                // Start auto refresh if enabled
                if (document.getElementById('autoRefreshToggle').checked) {
                    startJobDetailPolling();
                }
            } catch (err) {
                errorBanner.textContent = `åŠ è½½å¤±è´¥: ${err.message}`;
                errorBanner.classList.add('show');
                content.style.display = 'none';
            }
        }

        // Render job detail
        function renderJobDetail(job, items) {
            // Summary
            document.getElementById('jobDetailId').textContent = job.id;
            document.getElementById('jobDetailRootPath').textContent = job.root_path || '-';
            
            const statusText = getStatusText(job.status);
            const statusClass = job.status || 'pending';
            const statusEl = document.getElementById('jobDetailStatus');
            statusEl.innerHTML = ''; // Clear first
            const statusTag = document.createElement('span');
            statusTag.className = `status-tag ${escapeHtml(statusClass)}`;
            statusTag.textContent = statusText;
            statusEl.appendChild(statusTag);
            
            // Progress
            const total = job.total || 0;
            const done = (job.success || 0) + (job.failed || 0) + (job.skipped || 0) + (job.canceled || 0);
            const percent = total > 0 ? Math.round((done / total) * 100) : 0;
            const progressBar = document.getElementById('jobDetailProgressBar');
            progressBar.style.width = `${percent}%`;
            progressBar.textContent = `${percent}% (${done}/${total})`;
            
            // Counts
            document.getElementById('jobDetailSuccess').textContent = job.success || 0;
            document.getElementById('jobDetailFailed').textContent = job.failed || 0;
            document.getElementById('jobDetailSkipped').textContent = job.skipped || 0;
            document.getElementById('jobDetailCanceled').textContent = job.canceled || 0;
            document.getElementById('jobDetailTotal').textContent = total;
            
            // Times
            document.getElementById('jobDetailCreatedAt').textContent = formatTime(job.created_at) || '-';
            document.getElementById('jobDetailStartedAt').textContent = formatTime(job.started_at) || '-';
            
            const endedAtEl = document.getElementById('jobDetailEndedAt');
            if (job.ended_at) {
                endedAtEl.textContent = formatTime(job.ended_at);
            } else if (job.started_at) {
                const elapsed = Math.floor((Date.now() - job.started_at) / 1000);
                endedAtEl.textContent = `è¿è¡Œä¸­... (å·²è¿è¡Œ ${elapsed} ç§’)`;
            } else {
                endedAtEl.textContent = '-';
            }
            
            // Items table
            renderJobItems(items);
        }

        // Render job items
        function renderJobItems(items) {
            const filterFailed = document.getElementById('filterFailed').checked;
            let filteredItems = items;
            
            if (filterFailed) {
                filteredItems = items.filter(item => item.status === 'failed');
            }
            
            const tableBody = document.getElementById('jobDetailItemsTable');
            
            if (filteredItems.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 20px; color: #999;">
                            ${filterFailed ? 'æ²¡æœ‰å¤±è´¥çš„ä»»åŠ¡é¡¹' : 'æš‚æ— ä»»åŠ¡é¡¹'}
                        </td>
                    </tr>
                `;
                return;
            }
            
            tableBody.innerHTML = filteredItems.map(item => {
                const statusClass = item.status || 'pending';
                const statusText = getStatusText(item.status);
                
                // Calculate duration
                let duration = '-';
                if (item.started_at && item.ended_at) {
                    const ms = item.ended_at - item.started_at;
                    if (ms < 1000) {
                        duration = `${ms}ms`;
                    } else {
                        duration = `${(ms / 1000).toFixed(1)}s`;
                    }
                }
                
                // Truncate path
                const fullPath = item.archive_path || '-';
                const truncatedPath = fullPath.length > 50 ? fullPath.substring(0, 47) + '...' : fullPath;
                
                return `
                    <tr>
                        <td class="path-cell" style="position: relative;">
                            <span>${escapeHtml(truncatedPath)}</span>
                            <span class="path-full">${escapeHtml(fullPath)}</span>
                            <button class="copy-btn" data-copy-path="${escapeHtml(fullPath).replace(/"/g, '&quot;')}" onclick="copyToClipboard(this.getAttribute('data-copy-path'))">å¤åˆ¶</button>
                        </td>
                        <td>
                            <span class="status-tag ${escapeHtml(statusClass)}">${escapeHtml(statusText)}</span>
                        </td>
                        <td>
                            ${item.failed_detail ? escapeHtml(item.failed_detail) : '-'}
                            ${item.failed_detail ? `<button class="copy-btn" data-copy-detail="${escapeHtml(item.failed_detail).replace(/"/g, '&quot;')}" onclick="copyToClipboard(this.getAttribute('data-copy-detail'))">å¤åˆ¶</button>` : ''}
                        </td>
                        <td>
                            ${item.out_dir ? escapeHtml(item.out_dir) : '-'}
                            ${item.out_dir ? `<button class="copy-btn" onclick="copyToClipboard('${escapeHtml(item.out_dir).replace(/'/g, "\\'")}')">å¤åˆ¶</button>` : ''}
                        </td>
                        <td>${duration}</td>
                    </tr>
                `;
            }).join('');
        }

        // Copy to clipboard
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                const toast = document.getElementById('toast');
                toast.classList.add('show');
                setTimeout(() => {
                    toast.classList.remove('show');
                }, 2000);
            }).catch(err => {
                console.error('Copy failed:', err);
            });
        }

        // Start polling
        function startJobDetailPolling() {
            stopJobDetailPolling();
            
            const interval = parseInt(document.getElementById('refreshInterval').value) || 2000;
            
            jobDetailPollInterval = setInterval(async () => {
                if (!currentJobId) return;
                
                try {
                    const data = await fetchJobDetail(currentJobId);
                    jobDetailData = data;
                    
                    renderJobDetail(data.job, data.items);
                    
                    // Stop polling if job is in final state
                    const finalStates = ['completed', 'failed', 'canceled'];
                    if (finalStates.includes(data.job.status)) {
                        stopJobDetailPolling();
                    }
                } catch (err) {
                    // Show error but keep last data
                    const errorBanner = document.getElementById('jobDetailError');
                    errorBanner.textContent = `åˆ·æ–°å¤±è´¥: ${err.message} (ä¿ç•™ä¸Šæ¬¡æ•°æ®)`;
                    errorBanner.classList.add('show');
                }
            }, interval);
        }

        // Stop polling
        function stopJobDetailPolling() {
            if (jobDetailPollInterval) {
                clearInterval(jobDetailPollInterval);
                jobDetailPollInterval = null;
            }
        }

        // Auto refresh toggle
        document.getElementById('autoRefreshToggle').addEventListener('change', (e) => {
            if (e.target.checked) {
                startJobDetailPolling();
            } else {
                stopJobDetailPolling();
            }
        });

        // Refresh interval change
        document.getElementById('refreshInterval').addEventListener('change', () => {
            if (document.getElementById('autoRefreshToggle').checked) {
                startJobDetailPolling();
            }
        });

        // Filter failed toggle
        document.getElementById('filterFailed').addEventListener('change', () => {
            if (jobDetailData) {
                renderJobItems(jobDetailData.items);
            }
        });

        // Manual refresh
        document.getElementById('manualRefreshBtn').addEventListener('click', () => {
            if (currentJobId) {
                loadJobDetail(currentJobId);
            }
        });

        // Stop polling when leaving page
        window.addEventListener('hashchange', () => {
            const hash = window.location.hash;
            if (!hash.startsWith('#jobs/')) {
                stopJobDetailPolling();
                currentJobId = null;
            }
        });
    </script>
</body>
</html>

